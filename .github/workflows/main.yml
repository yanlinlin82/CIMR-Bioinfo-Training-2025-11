# Quarto render workflow for yanlinlin82/CIMR-Bioinfo-Training-2025-11
# Triggers on push and PR to main and manual dispatch.
# Supports both R and Python. Uses conda if environment.yml exists,
# falls back to requirements.txt or pip, and runs packages.R if present.
name: Quarto — Render site

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          # adjust R version if needed
          r-version: '4.2'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          # make conda available on PATH for subsequent steps
          activate-environment: base

      - name: Install Quarto CLI (via conda-forge)
        shell: bash
        run: |
          set -euo pipefail
          # Prefer installing quarto into conda if possible.
          # If you later create a specific conda env (environment.yml), we will also install quarto into that env.
          conda install -y -c conda-forge quarto || {
            echo "conda install of quarto failed — trying mamba (if available)"; \
            mamba install -y -c conda-forge quarto || true;
          }
          # Verify quarto available
          if command -v quarto >/dev/null 2>&1; then
            echo "Quarto installed: $(quarto --version)"
          else
            echo "Warning: quarto not found on PATH after conda install — rendering may fail"
          fi

      - name: Prepare environment and set render command
        id: prepare
        shell: bash
        run: |
          set -euo pipefail

          # default render command
          echo "RENDER_CMD=quarto render" >> $GITHUB_ENV
          echo "OUTPUT_DIR=_site" >> $GITHUB_ENV

          if [ -f environment.yml ]; then
            echo "Found environment.yml — creating/updating conda env 'quarto-env'"
            # create or update the named environment (quarto-env) from environment.yml
            conda env create -f environment.yml -n quarto-env || conda env update -f environment.yml -n quarto-env
            # ensure conda-forge quarto is available in that env
            conda install -n quarto-env -y -c conda-forge quarto || true
            # run quarto from inside the env to ensure kernels & python packages from env are available
            echo "RENDER_CMD=conda run -n quarto-env quarto render" >> $GITHUB_ENV
          elif [ -f requirements.txt ]; then
            echo "Found requirements.txt — installing pip packages into system Python"
            python -m pip install --upgrade pip
            python -m pip install -r requirements.txt
            echo "RENDER_CMD=quarto render" >> $GITHUB_ENV
          else
            echo "No environment.yml or requirements.txt found — using system/conda-installed quarto"
          fi

      - name: Install R packages (if packages.R exists)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f packages.R ]; then
            echo "Running packages.R to install R dependencies"
            Rscript packages.R
          else
            echo "No packages.R found — skipping R package install"
          fi

      - name: Render Quarto site
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RENDER_CMD: ${{ env.RENDER_CMD }}
        run: |
          set -euo pipefail
          echo "Running render command: $RENDER_CMD"
          # run the render; this will use either conda run -n quarto-env quarto render or quarto render
          eval "$RENDER_CMD"

      - name: List rendered files (debug)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          OUTPUT_DIR="${OUTPUT_DIR:-_site}"
          echo "Checking for output directory: $OUTPUT_DIR"
          if [ -d "$OUTPUT_DIR" ]; then
            echo "Rendered site files:"
            find "$OUTPUT_DIR" -maxdepth 2 -type f -print | sed -n '1,200p'
          else
            echo "Output dir '$OUTPUT_DIR' not found — Quarto may have rendered to a different folder or failed."
            ls -la
          fi

      - name: Upload rendered site artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quarto-site
          path: ${{ env.OUTPUT_DIR }}

  # Optional: Deploy to GitHub Pages (uncomment to enable)
  deploy:
    needs: render
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Pages
        uses: actions/configure-pages@v3

      - name: Download site artifact
        uses: actions/download-artifact@v4
        with:
          name: quarto-site
          path: site

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: site/${{ env.OUTPUT_DIR }}

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v2
